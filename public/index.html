<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YSBA Live - Select Division & Tier</title>
    
    <!-- Cache Control -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- Basic Meta Tags -->
    <meta name="description" content="YSBA Live - Real-time baseball standings and schedules for all York Simcoe Baseball Association divisions">
    <meta name="keywords" content="YSBA, baseball, standings, live, schedules, select, rep, house league, york, simcoe">
    <meta name="author" content="YSBA Live">
    
    <!-- Web App Meta -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="YSBA Standings">
    <meta name="theme-color" content="#024220">
    <link rel="manifest" href="/manifest.json?v=321200">
    
    <!-- Default Icon -->
    <link rel="icon" type="image/svg+xml" href="/icons/icon.svg?v=147416">
    
    <!-- iOS App Icons -->
    <link rel="apple-touch-icon" href="/icons/ios/AppIcon@3x.png?v=321200">
    <link rel="apple-touch-icon" sizes="60x60" href="/icons/ios/AppIcon-20@3x.png?v=321200">
    <link rel="apple-touch-icon" sizes="76x76" href="/icons/ios/AppIcon~ipad.png?v=321200">
    <link rel="apple-touch-icon" sizes="120x120" href="/icons/ios/AppIcon@2x.png?v=321200">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/ios/AppIcon@2x~ipad.png?v=321200">
    <link rel="apple-touch-icon" sizes="167x167" href="/icons/ios/AppIcon-83.5@2x~ipad.png?v=321200">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/ios/AppIcon@3x.png?v=321200">
    
    <!-- Android Icons -->
    <link rel="icon" type="image/png" sizes="48x48" href="/icons/android/res/mipmap-mdpi/ic_launcher.png?v=321200">
    <link rel="icon" type="image/png" sizes="72x72" href="/icons/android/res/mipmap-hdpi/ic_launcher.png?v=321200">
    <link rel="icon" type="image/png" sizes="96x96" href="/icons/android/res/mipmap-xhdpi/ic_launcher.png?v=321200">
    <link rel="icon" type="image/png" sizes="144x144" href="/icons/android/res/mipmap-xxhdpi/ic_launcher.png?v=321200">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/android/res/mipmap-xxxhdpi/ic_launcher.png?v=321200">
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/android/play_store_512.png?v=321200">
    
    <!-- Fonts and Styles -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/styles.css?v=147416">
    
</head>
<body id="home" class="modern-body">
    <!-- Header Navigation -->
    <header class="clean-header">
        <div class="container">
            <div class="header-content">
                <div class="header-top">
                    <div class="brand-section">
                        <div class="brand-text">
                            <h1 class="brand-title">
                                <a href="/">
                                    <span class="title-icon">
                                        <svg width="109" height="" viewBox="0 0 109 129" fill="none" xmlns="http://www.w3.org/2000/svg" style="
    width: 23px;
">
                                            <path d="M65.1088 23.881C64.3417 22.642 63.1144 21.7579 61.6963 21.4226C60.2782 21.0872 58.785 21.328 57.5442 22.0922C56.3034 22.8563 55.4163 24.0813 55.0775 25.4986C54.7387 26.9159 54.9758 28.4097 55.7369 29.6524C56.7096 31.2269 57.7467 32.7746 58.8483 34.2954C59.7065 35.4725 60.9965 36.2613 62.4355 36.4887C63.8744 36.7162 65.3448 36.3637 66.5242 35.5087C67.7036 34.6536 68.4959 33.3657 68.7272 31.9274C68.9585 30.4891 68.61 29.0178 67.7581 27.8361C66.8178 26.541 65.9347 25.2226 65.1088 23.881ZM50.089 74.6257C49.66 74.0442 49.1206 73.5529 48.5016 73.1798C47.8827 72.8068 47.1964 72.5593 46.4818 72.4515C45.7672 72.3437 45.0384 72.3778 44.337 72.5516C43.6356 72.7255 42.9752 73.0358 42.3938 73.4649C41.8123 73.894 41.321 74.4334 40.9479 75.0523C40.5749 75.6712 40.3274 76.3576 40.2196 77.0721C40.1118 77.7867 40.1459 78.5155 40.3197 79.2169C40.4936 79.9184 40.8039 80.5787 41.233 81.1602C42.168 82.423 43.0332 83.7289 43.85 85.0616C44.2283 85.6777 44.7241 86.2132 45.3094 86.6377C45.8946 87.0621 46.5577 87.3671 47.2608 87.5353C47.9639 87.7034 48.6932 87.7315 49.4071 87.6178C50.121 87.5041 50.8056 87.2509 51.4217 86.8726C52.0377 86.4944 52.5733 85.9985 52.9977 85.4133C53.4221 84.828 53.7271 84.165 53.8953 83.4619C54.0635 82.7588 54.0915 82.0294 53.9778 81.3155C53.8641 80.6016 53.6109 79.917 53.2327 79.301C52.2547 77.7102 51.2068 76.1465 50.089 74.6257ZM29.6903 55.7583C29.0742 55.3807 28.3898 55.1282 27.6762 55.0152C26.9625 54.9021 26.2336 54.9308 25.531 55.0994C24.8284 55.2681 24.1659 55.5735 23.5813 55.9982C22.9967 56.4229 22.5016 56.9586 22.124 57.5746C21.7465 58.1907 21.494 58.8751 21.3809 59.5888C21.2679 60.3024 21.2965 61.0314 21.4652 61.734C21.6338 62.4366 21.9392 63.0991 22.3639 63.6836C22.7886 64.2682 23.3243 64.7634 23.9404 65.1409C25.2731 65.9577 26.5807 66.8354 27.8632 67.7741C28.4474 68.2023 29.1103 68.511 29.814 68.6825C30.5177 68.854 31.2483 68.885 31.964 68.7736C32.6797 68.6622 33.3663 68.4107 33.9846 68.0334C34.6029 67.6561 35.1407 67.1606 35.567 66.5751C35.9934 65.9896 36.3001 65.3257 36.4694 64.6214C36.6387 63.9172 36.6673 63.1865 36.5537 62.4712C36.4401 61.7558 36.1864 61.07 35.8071 60.4529C35.4279 59.8358 34.9307 59.2996 34.3438 58.875C32.8231 57.7679 31.272 56.729 29.6903 55.7583ZM85.0511 43.8338C83.713 43.0116 82.4 42.1321 81.1121 41.1952C79.9318 40.3402 78.4606 39.9882 77.0211 40.2164C75.5816 40.4446 74.2914 41.2343 73.4334 42.4125C72.5754 43.5906 72.2197 45.061 72.4442 46.501C72.6688 47.9411 73.4553 49.2333 74.6313 50.0942C76.1521 51.2012 77.7051 52.242 79.2904 53.2164C79.9064 53.5947 80.591 53.8479 81.3049 53.9616C82.0188 54.0753 82.7482 54.0472 83.4513 53.8791C84.1543 53.7109 84.8174 53.4059 85.4027 52.9815C85.9879 52.5571 86.4838 52.0215 86.862 51.4055C87.2403 50.7894 87.4935 50.1049 87.6072 49.3909C87.7209 48.677 87.6929 47.9477 87.5247 47.2446C87.3565 46.5415 87.0515 45.8784 86.6271 45.2932C86.2027 44.708 85.6672 44.2121 85.0511 43.8338ZM93.0095 15.9601C85.3903 8.33991 75.6826 3.15024 65.1139 1.04743C54.5452 -1.05538 43.5902 0.0231118 33.6345 4.14652C23.6787 8.26993 15.1693 15.253 9.18242 24.2127C3.19551 33.1725 0 43.7063 0 54.4822C0 65.2581 3.19551 75.7919 9.18242 84.7516C15.1693 93.7114 23.6787 100.694 33.6345 104.818C43.5902 108.941 54.5452 110.02 65.1139 107.917C75.6826 105.814 85.3903 100.624 93.0095 93.0043C103.209 82.7787 108.938 68.9252 108.938 54.4822C108.938 40.0392 103.209 26.1857 93.0095 15.9601ZM86.0021 85.9966C79.2827 92.7342 70.5677 97.1224 61.1537 98.5085C60.6791 97.6236 59.9648 96.8904 59.0926 96.3929C58.2204 95.8955 57.2256 95.654 56.2224 95.696C55.2192 95.7381 54.2482 96.0621 53.4207 96.6308C52.5932 97.1995 51.9428 97.99 51.544 98.9115C40.7744 98.2285 30.623 93.6434 22.9907 86.0145C15.3584 78.3857 10.7686 68.2365 10.0807 57.4672C10.996 57.0618 11.7797 56.4084 12.3431 55.5809C12.9065 54.7535 13.2272 53.7849 13.2689 52.7847C13.3105 51.7844 13.0716 50.7925 12.579 49.921C12.0864 49.0495 11.3598 48.3332 10.4814 47.8531C11.8571 38.4365 16.2325 29.7146 22.9582 22.982C29.6839 16.2494 38.4014 11.865 47.8165 10.4798C48.295 11.3075 48.9816 11.9958 49.8081 12.4764C50.6347 12.9569 51.5725 13.2131 52.5286 13.2194C52.9537 13.2186 53.3773 13.1699 53.7915 13.0743C54.5835 12.8798 55.3212 12.5085 55.9494 11.9884C56.5775 11.4682 57.0797 10.8126 57.4184 10.0707C68.1999 10.7428 78.3648 15.3293 86.0028 22.9682C93.6408 30.6072 98.226 40.7727 98.8967 51.5543C97.9857 51.9589 97.2059 52.6098 96.645 53.4338C96.0842 54.2578 95.7646 55.2221 95.7224 56.218C95.6801 57.2139 95.9169 58.2017 96.4059 59.0703C96.895 59.9388 97.6169 60.6535 98.4903 61.1338C97.1074 70.548 92.7283 79.2662 86.0021 85.9966Z" fill="#034220"></path>
                                            </svg>
                                    </span> 
                                     YSBA <span class="fw-light">LIVE</span>
                                </a>
                            </h1>
                            <div class="dropdown">
                                <button class="brand-subtitle-btn" 
                                        type="button" 
                                        data-bs-toggle="dropdown" 
                                        aria-expanded="false"
                                        id="divisionTierSelector">
                                    <span class="dropdown-button-text">Select Division & Tier</span>
                                    <i class="bi bi-chevron-down"></i>
                                </button>
                                <ul class="dropdown-menu" id="divisionTierMenu">
                                    <!-- Populated by JavaScript -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <div class="container-fluid p-0">
            <!-- AI-Generated Stories Magazine Section -->
            <section class="magazine-section" id="magazineSection" style="display: none;">
                <div class="magazine-container">
                    <div id="storiesContent">
                        <div class="stories-loading">
                            <div class="spinner"></div>
                            <p>Generating exciting stories from the latest games...</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Loading State -->
            <div id="loadingState" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading divisions...</span>
                </div>
                <p class="mt-3 text-muted">Loading available divisions...</p>
            </div>

            <!-- Rep Divisions -->
            <div class="category-section">
                <h2 class="category-header">🏆 Rep Divisions</h2>
                <div class="division-grid" id="repDivisions">
                    <!-- Rep divisions will be populated by JavaScript -->
                </div>
            </div>

            <!-- Select Divisions -->
            <div class="category-section">
                <h2 class="category-header">⭐ Select Divisions</h2>
                <div class="division-grid" id="selectDivisions">
                    <!-- Select divisions will be populated by JavaScript -->
                </div>
            </div>


        </div>
    </main>

    <!-- Footer -->
    <footer class="modern-footer">
        <div class="container">
            <div class="footer-content">
                <p>York Simcoe Baseball Association Standings</p>
                <p class="footer-note">
                    <i class="bi bi-info-circle"></i>&nbsp;&nbsp; 
                    Select your division and tier to view real-time standings and schedules
                </p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class DivisionSelector {
            constructor() {
                this.divisions = {};
                this.init();
            }

            async init() {
                await this.loadDivisions();
                this.renderDivisions();
            }

            async loadDivisions() {
                try {
                    const response = await fetch('/api/divisions?filterEmpty=true');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.divisions = result.divisions;
                    } else {
                        console.error('Failed to load divisions:', result.error);
                    }
                } catch (error) {
                    console.error('Error loading divisions:', error);
                }
            }

            renderDivisions() {
                const categories = {
                    rep: document.getElementById('repDivisions'),
                    select: document.getElementById('selectDivisions')
                };

                Object.entries(this.divisions).forEach(([key, division]) => {
                    const card = this.createDivisionCard(key, division);
                    
                    // Determine category based on division key
                    if (key.includes('-rep')) {
                        categories.rep.appendChild(card);
                    } else if (key.includes('-select')) {
                        categories.select.appendChild(card);
                    }
                });
            }

            createDivisionCard(key, division) {
                const card = document.createElement('div');
                card.className = 'division-card';
                card.setAttribute('data-theme', key);
                
                // Set CSS custom properties for theming
                card.style.setProperty('--theme-primary', division.theme.primary);
                
                const tierButtons = Object.entries(division.tiers)
                    .map(([tierKey, tier]) => 
                        `<a href="/${key}/${tierKey}" class="tier-btn">${tier.displayName}</a>`
                    ).join('');

                card.innerHTML = `
                    <div class="division-title">${division.displayName}</div>
                    <div class="division-description">
                        ${this.getDivisionDescription(key, division)}
                    </div>
                    <div class="tier-buttons">
                        ${tierButtons}
                    </div>
                `;

                return card;
            }

            getDivisionDescription(key, division) {
                const descriptions = {
                    'rep': 'Competitive representative baseball',
                    'select': 'Competitive select division play'
                };

                const type = key.split('-')[1];
                return descriptions[type] || 'Baseball standings and schedules';
            }
        }

        class MagazineSection {
            constructor() {
                this.storiesContainer = document.getElementById('storiesContent');
                this.magazineSection = document.getElementById('magazineSection');
                this.loadStories();
            }

            async loadStories() {
                try {
                    // Always show magazine section
                    this.magazineSection.style.display = 'block';
                    
                    const response = await fetch('/api/stories');
                    const data = await response.json();

                    if (data.success && data.stories && data.stories.length > 0) {
                        this.renderStories(data.stories);
                    } else {
                        // Show loading state while stories are being generated
                        this.showLoadingState();
                        console.log('No AI stories available yet, showing loading state');
                    }
                } catch (error) {
                    console.error('Error loading stories:', error);
                    this.renderFallbackStories();
                }
            }

            showLoadingState() {
                this.storiesContainer.innerHTML = `
                    <div class="stories-loading">
                        <div class="spinner"></div>
                        <p>Generating exciting stories from the latest games...</p>
                        <p class="loading-subtext">This may take a moment while we analyze all the YSBA action</p>
                    </div>
                `;
            }

            renderFallbackStories() {
                const fallbackStories = [
                    {
                        headline: "Twins Stay Perfect with Explosive 8-0 Start!",
                        body: "The Midland Penetang Twins 9U DS continue their incredible undefeated season, outscoring opponents 118-46 while dominating the Select division.",
                        division: "9U Select",
                        generatedAt: new Date().toISOString(),
                        type: "undefeated"
                    },
                    {
                        headline: "Vikings and Mariners Roll Undefeated",
                        body: "Both Vaughan Vikings 8U A and Markham Mariners 9U A remain perfect this season.",
                        division: "Rep Divisions", 
                        generatedAt: new Date().toISOString(),
                        type: "undefeated"
                    },
                    {
                        headline: "Phoenix Shutout Streak Amazing",
                        body: "Richmond Hill Phoenix 14U A hasn't allowed a run in their last two games.",
                        division: "14U Rep",
                        generatedAt: new Date().toISOString(),
                        type: "hot_streak"
                    },
                    {
                        headline: "Thunder Fights Back for First Win",
                        body: "TNT Thunder 8U A finally broke through with an emotional victory.",
                        division: "8U Rep",
                        generatedAt: new Date().toISOString(),
                        type: "breakthrough"
                    }
                ];
                
                this.renderStories(fallbackStories);
            }

            renderStories(stories) {
                if (!stories || stories.length === 0) {
                    this.storiesContainer.innerHTML = `
                        <div class="stories-loading">
                            <p>No stories available at the moment.</p>
                        </div>
                    `;
                    return;
                }

                // Create a diverse layout with different story types
                const layout = this.createStoryLayout(stories);
                
                let html = '<div class="stories-grid">';
                
                layout.forEach((item, index) => {
                    const story = item.story;
                    const storyClass = `story-${item.type} story-type-${story.type}`;
                    
                    switch (item.type) {
                        case 'hero':
                            html += `
                                <div class="${storyClass}">
                                    <h1 class="hero-headline">${this.escapeHtml(story.headline)}</h1>
                                    <p class="hero-body">${this.escapeHtml(story.body)}</p>
                                    <div class="story-meta">
                                        <span class="story-division">${this.escapeHtml(story.division)}</span>
                                        <a href="${this.getDivisionSlug(story.division)}" class="story-time">View standings</a>
                                    </div>
                                </div>
                            `;
                            break;
                            
                        case 'featured':
                            html += `
                                <div class="${storyClass}">
                                    <h2 class="featured-headline">${this.escapeHtml(story.headline)}</h2>
                                    <p class="featured-body">${this.escapeHtml(story.body)}</p>
                                    <div class="story-meta">
                                        <span class="story-division">${this.escapeHtml(story.division)}</span>
                                        <a href="${this.getDivisionSlug(story.division)}" class="story-time">View standings</a>
                                    </div>
                                </div>
                            `;
                            break;
                            
                        case 'compact':
                            html += `
                                <div class="${storyClass}">
                                    <h2 class="compact-headline">${this.escapeHtml(story.headline)}</h2>
                                    <p class="compact-body">${this.escapeHtml(story.body)}</p>
                                    <div class="story-meta">
                                        <span class="story-division">${this.escapeHtml(story.division)}</span>
                                        <a href="${this.getDivisionSlug(story.division)}" class="story-time">View standings</a>
                                    </div>
                                </div>
                            `;
                            break;
                            
                        case 'mini':
                            // Extract key stat from story
                            const stat = this.extractStat(story);
                            html += `
                                <div class="${storyClass}">
                                    <div class="mini-content">
                                        <div class="mini-stat-container">
                                            <div class="mini-stat">${stat.value}</div>
                                            <div class="mini-label">${stat.label}</div>
                                        </div>
                                        <div class="mini-text">
                                            <h3 class="mini-headline">${this.escapeHtml(story.headline)}</h3>
                                            <p class="mini-body">${this.escapeHtml(story.body)}</p>
                                        </div>
                                    </div>
                                    <div class="story-meta">
                                        <span class="story-division">${this.escapeHtml(story.division)}</span>
                                        <a href="${this.getDivisionSlug(story.division)}" class="story-time">View standings</a>
                                    </div>
                                </div>
                            `;
                            break;
                            
                        case 'cta':
                            const divisionSlug = this.getDivisionSlug(story.division);
                            html += `
                                <a href="${divisionSlug}" class="${storyClass}">
                                    <h3 class="cta-headline">View ${story.division} Standings</h3>
                                    <p class="cta-body">See full standings, schedules and team stats</p>
                                    <div class="cta-button">View Standings</div>
                                </a>
                            `;
                            break;
                            
                        case 'wide':
                            html += `
                                <div class="${storyClass}">
                                    <div class="wide-content">
                                        <h2 class="wide-headline">${this.escapeHtml(story.headline)}</h2>
                                        <p class="wide-body">${this.escapeHtml(story.body)}</p>
                                    </div>
                                    <div class="story-meta">
                                        <span class="story-division">${this.escapeHtml(story.division)}</span>
                                        <a href="${this.getDivisionSlug(story.division)}" class="story-time">View standings</a>
                                    </div>
                                </div>
                            `;
                            break;
                    }
                });
                
                html += '</div>';
                this.storiesContainer.innerHTML = html;
            }
            
            createStoryLayout(stories) {
                const layout = [];
                
                // Ensure we have enough stories for a good layout
                const availableStories = [...stories];
                
                // Row 1: Hero (8 cols) + Featured (4 cols) = 12 cols
                if (availableStories.length > 0) {
                    layout.push({ type: 'hero', story: availableStories.shift() });
                }
                if (availableStories.length > 0) {
                    layout.push({ type: 'featured', story: availableStories.shift() });
                }
                
                // Row 2: 4 mini cards (3 cols each) = 12 cols
                for (let i = 0; i < 4 && availableStories.length > 0; i++) {
                    layout.push({ type: 'mini', story: availableStories.shift() });
                }
                
                // Row 3: Featured (4 cols) + CTA (4 cols) + Compact (4 cols) = 12 cols
                if (availableStories.length > 0) {
                    layout.push({ type: 'featured', story: availableStories.shift() });
                }
                if (availableStories.length > 0) {
                    const story = availableStories.shift();
                    layout.push({ type: 'cta', story: story, division: story.division });
                }
                if (availableStories.length > 0) {
                    layout.push({ type: 'compact', story: availableStories.shift() });
                }
                
                // Row 4: Wide story (12 cols)
                if (availableStories.length > 0) {
                    layout.push({ type: 'wide', story: availableStories.shift() });
                }
                
                // Row 5: Featured (4 cols) + Featured (4 cols) + Compact (4 cols) = 12 cols
                if (availableStories.length > 0) {
                    layout.push({ type: 'featured', story: availableStories.shift() });
                }
                if (availableStories.length > 0) {
                    layout.push({ type: 'featured', story: availableStories.shift() });
                }
                if (availableStories.length > 0) {
                    layout.push({ type: 'compact', story: availableStories.shift() });
                }
                
                return layout;
            }

            extractStat(story) {
                // Extract key stats based on story type
                switch(story.type) {
                    case 'undefeated':
                        const matches = story.headline.match(/(\d+-\d+)/);
                        if (matches) {
                            return { value: matches[1], label: 'Record' };
                        }
                        // If not found in headline, check body text
                        const bodyMatches = story.body.match(/(\d+-\d+)/);
                        return { value: bodyMatches ? bodyMatches[1] : '0-0', label: 'Record' };
                    case 'hot_streak':
                        // Look for record pattern first (e.g., "8-0", "4-1"), then fall back to any number
                        const recordMatch = story.headline.match(/(\d+-\d+)/);
                        if (recordMatch) {
                            const wins = recordMatch[1].split('-')[0];
                            return { value: wins, label: 'Wins' };
                        }
                        // If not found in headline, check body text
                        const bodyRecordMatch = story.body.match(/(\d+-\d+)/);
                        if (bodyRecordMatch) {
                            const wins = bodyRecordMatch[1].split('-')[0];
                            return { value: wins, label: 'Wins' };
                        }
                        const pctMatch = story.headline.match(/(\d+)/);
                        return { value: pctMatch ? pctMatch[1] : '0', label: 'Wins' };
                    case 'scoring_machine':
                        const runsMatch = story.body.match(/(\d+) runs/i);
                        return { value: runsMatch ? runsMatch[1] : '0', label: 'Runs' };
                    case 'shutout_artist':
                        const allowedMatch = story.body.match(/(\d+) runs/i);
                        return { value: allowedMatch ? allowedMatch[1] : '0', label: 'Runs Allowed' };
                    case 'tight_race':
                        return { value: '1', label: 'Game Gap' };
                    default:
                        return { value: '⚾', label: 'YSBA' };
                }
            }
            
            truncateText(text, maxLength) {
                if (text.length <= maxLength) return text;
                return text.substr(0, maxLength) + '...';
            }
            
            getDivisionSlug(division) {
                // Parse division name to create URL slug
                // Examples: "15U Rep AA" -> "/15U-rep/tier-2", "9U Select" -> "/9U-select/all-tiers"
                
                // Extract age group (e.g., "15U" from "15U Rep AA")
                const ageMatch = division.match(/(\d+U)/);
                if (!ageMatch) return '/';
                
                const age = ageMatch[1];
                
                // Check if it's a select division
                if (division.includes('Select')) {
                    return `/${age}-select/all-tiers`;
                }
                
                // Handle rep divisions with tier mapping
                if (division.includes('Rep')) {
                    let tierPath;
                    if (division.includes('AAA')) {
                        tierPath = 'tier-1';
                    } else if (division.includes('AA')) {
                        tierPath = 'tier-2';
                    } else if (division.includes(' A')) {
                        tierPath = 'tier-3';
                    } else {
                        // Default rep tier mappings by age
                        const defaultTiers = {
                            '8U': 'tier-3',
                            '9U': 'tier-3', 
                            '10U': 'tier-3',
                            '11U': 'tier-3',
                            '12U': 'tier-3',
                            '13U': 'tier-3',
                            '14U': 'tier-3',
                            '15U': 'tier-3',
                            '16U': 'tier-2',
                            '18U': 'no-tier',
                            '22U': 'no-tier'
                        };
                        tierPath = defaultTiers[age] || 'tier-3';
                    }
                    return `/${age}-rep/${tierPath}`;
                }
                
                // Fallback to homepage
                return '/';
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            formatTimeAgo(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));

                if (diffInHours < 1) {
                    return 'Just now';
                } else if (diffInHours === 1) {
                    return '1 hour ago';
                } else if (diffInHours < 24) {
                    return `${diffInHours} hours ago`;
                } else {
                    const diffInDays = Math.floor(diffInHours / 24);
                    if (diffInDays === 1) {
                        return '1 day ago';
                    } else {
                        return `${diffInDays} days ago`;
                    }
                }
            }
        }

        class NavigationHandler {
            constructor() {
                this.allDivisions = {};
                this.init();
            }
            
            async init() {
                await this.loadNavigationData();
                this.createMegaMenu();
                this.createMobileModal();
                this.setupMegaMenuEvents();
                this.setupMobileModalEvents();
            }
            
            async loadNavigationData() {
                try {
                    const response = await fetch('/api/divisions?filterEmpty=true');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.allDivisions = result.divisions;
                    }
                } catch (error) {
                    console.error('Error loading navigation data:', error);
                }
            }
            
            createMegaMenu() {
                // Remove existing mega menu if it exists
                const existingMegaMenu = document.querySelector('.mega-menu');
                if (existingMegaMenu) {
                    existingMegaMenu.remove();
                }

                // Create mega menu structure
                const megaMenu = document.createElement('div');
                megaMenu.className = 'mega-menu';
                megaMenu.innerHTML = `
                    <div class="mega-menu-content">
                        <div class="mega-menu-header">
                            <h3 class="mega-menu-title">Choose Division & Tier</h3>
                            <p class="mega-menu-subtitle">Select your division and tier to view standings</p>
                        </div>
                        <div class="mega-menu-grid">
                            <div class="mega-menu-section rep-section">
                                <h4 class="mega-menu-section-title">Rep Divisions</h4>
                                <div class="mega-menu-items rep-divisions" id="rep-divisions"></div>
                            </div>
                            <div class="mega-menu-section select-section">
                                <h4 class="mega-menu-section-title">Select Divisions</h4>
                                <div class="mega-menu-items" id="select-divisions"></div>
                            </div>
                        </div>
                    </div>
                `;

                // Populate divisions
                const repContainer = megaMenu.querySelector('#rep-divisions');
                const selectContainer = megaMenu.querySelector('#select-divisions');

                Object.entries(this.allDivisions).forEach(([key, division]) => {
                    const isRep = key.includes('-rep');
                    const container = isRep ? repContainer : selectContainer;
                    
                    const item = document.createElement('div');
                    item.className = 'mega-menu-item';
                    
                    if (isRep) {
                        // Rep divisions: Show all tiers as clickable badges
                        const tierKeys = Object.keys(division.tiers);
                        
                        // Create tier badges
                        const tierBadges = tierKeys.map(tierKey => {
                            const tier = division.tiers[tierKey];
                            return `<button class="mega-menu-tier-badge" 
                                            data-division="${key}" 
                                            data-tier="${tierKey}">
                                        ${tier.displayName}
                                    </button>`;
                        }).join('');
                        
                        item.innerHTML = `
                            <div class="mega-menu-item-content">
                                <div class="mega-menu-item-title">${division.displayName}</div>
                                <div class="mega-menu-item-subtitle">Choose Tier:</div>
                            </div>
                            <div class="mega-menu-tier-badges">
                                ${tierBadges}
                            </div>
                        `;
                    } else {
                        // Select divisions: Badge clickable like rep divisions
                        const mainTierKey = Object.keys(division.tiers)[0];
                        
                        item.innerHTML = `
                            <div class="mega-menu-item-content">
                                <div class="mega-menu-item-title">${division.displayName}</div>
                                <div class="mega-menu-item-subtitle">Select Division</div>
                            </div>
                            <button class="mega-menu-item-badge" 
                                    data-division="${key}" 
                                    data-tier="${mainTierKey}">
                                All Teams
                            </button>
                        `;
                    }
                    
                    container.appendChild(item);
                });

                // Insert mega menu after the dropdown button
                const brandText = document.querySelector('.brand-text');
                if (brandText) {
                    brandText.style.position = 'relative';
                    brandText.appendChild(megaMenu);
                }
            }

            createMobileModal() {
                // Remove existing modal if it exists
                const existingModal = document.querySelector('.division-modal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Create mobile modal structure
                const modal = document.createElement('div');
                modal.className = 'division-modal';
                modal.innerHTML = `
                    <div class="division-modal-content">
                        <div class="division-modal-header">
                            <h3 class="division-modal-title">Choose Division</h3>
                            <p class="division-modal-subtitle">Select your division and tier</p>
                            <button class="division-modal-close" aria-label="Close">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="division-modal-body">
                            <div class="division-modal-section">
                                <h4 class="division-modal-section-title">Rep Divisions</h4>
                                <div class="division-modal-items" id="mobile-rep-divisions"></div>
                            </div>
                            <div class="division-modal-section">
                                <h4 class="division-modal-section-title">Select Divisions</h4>
                                <div class="division-modal-items" id="mobile-select-divisions"></div>
                            </div>
                        </div>
                    </div>
                `;

                // Populate divisions
                const repContainer = modal.querySelector('#mobile-rep-divisions');
                const selectContainer = modal.querySelector('#mobile-select-divisions');

                Object.entries(this.allDivisions).forEach(([key, division]) => {
                    const isRep = key.includes('-rep');
                    const container = isRep ? repContainer : selectContainer;
                    
                    if (isRep) {
                        // Rep divisions: Create container with tier badges
                        const item = document.createElement('div');
                        item.className = 'division-modal-item rep-division';
                        
                        const tierKeys = Object.keys(division.tiers);
                        
                        // Create tier badges
                        const tierBadges = tierKeys.map(tierKey => {
                            const tier = division.tiers[tierKey];
                            return `<button class="division-modal-tier-badge" 
                                            data-division="${key}" 
                                            data-tier="${tierKey}">
                                        ${tier.displayName}
                                    </button>`;
                        }).join('');
                        
                        item.innerHTML = `
                            <div class="division-modal-item-content">
                                <div class="division-modal-item-title">${division.displayName}</div>
                                <div class="division-modal-item-subtitle">Choose Tier:</div>
                            </div>
                            <div class="division-modal-tier-badges">
                                ${tierBadges}
                            </div>
                        `;
                        
                        container.appendChild(item);
                    } else {
                        // Select divisions: Non-clickable container with clickable badge (like Rep divisions)
                        const tierKeys = Object.keys(division.tiers);
                        const mainTierKey = tierKeys[0];
                        
                        const item = document.createElement('div');
                        item.className = 'division-modal-item select-division';
                        
                        item.innerHTML = `
                            <div class="division-modal-item-content">
                                <div class="division-modal-item-title">${division.displayName}</div>
                                <div class="division-modal-item-subtitle">Select Division</div>
                            </div>
                            <div class="division-modal-tier-badges">
                                <button class="division-modal-tier-badge" 
                                        data-division="${key}" 
                                        data-tier="${mainTierKey}">
                                    All Teams
                                </button>
                            </div>
                        `;
                        
                        container.appendChild(item);
                    }
                });

                // Append modal to body
                document.body.appendChild(modal);
            }
            
            setupMegaMenuEvents() {
                const megaMenu = document.querySelector('.mega-menu');
                const dropdownBtn = document.querySelector('.brand-subtitle-btn');
                
                if (!megaMenu || !dropdownBtn) return;

                // Toggle mega menu on button click (desktop only)
                dropdownBtn.addEventListener('click', (e) => {
                    if (window.innerWidth >= 992) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const isOpen = megaMenu.classList.contains('show');
                        
                        if (isOpen) {
                            this.closeMegaMenu();
                        } else {
                            this.openMegaMenu();
                        }
                    }
                });

                // Handle mega menu clicks
                megaMenu.addEventListener('click', (e) => {
                    // Handle tier badge clicks (for Rep divisions)
                    const tierBadge = e.target.closest('.mega-menu-tier-badge');
                    if (tierBadge) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const division = tierBadge.dataset.division;
                        const tier = tierBadge.dataset.tier;
                        
                        // Navigate to standings page
                        window.location.href = `/${division}/${tier}`;
                        this.closeMegaMenu();
                        return;
                    }
                    
                    // Handle badge clicks (for Select divisions)
                    const badge = e.target.closest('.mega-menu-item-badge');
                    if (badge) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const division = badge.dataset.division;
                        const tier = badge.dataset.tier;
                        
                        // Navigate to standings page
                        window.location.href = `/${division}/${tier}`;
                        this.closeMegaMenu();
                        return;
                    }
                });

                // Close mega menu when clicking outside
                document.addEventListener('click', (e) => {
                    if (!dropdownBtn.contains(e.target) && !megaMenu.contains(e.target)) {
                        this.closeMegaMenu();
                    }
                });
            }

            setupMobileModalEvents() {
                const modal = document.querySelector('.division-modal');
                const dropdownBtn = document.querySelector('.brand-subtitle-btn');
                const closeBtn = modal?.querySelector('.division-modal-close');
                
                if (!modal || !dropdownBtn) return;

                // Open modal on button click (mobile only)
                dropdownBtn.addEventListener('click', (e) => {
                    if (window.innerWidth < 992) {
                        e.preventDefault();
                        e.stopPropagation();
                        this.openMobileModal();
                    }
                });

                // Close modal on close button click
                closeBtn?.addEventListener('click', () => {
                    this.closeMobileModal();
                });

                // Close modal on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeMobileModal();
                    }
                });

                // Handle modal clicks
                modal.addEventListener('click', (e) => {
                    // Handle tier badge clicks (for Rep divisions)
                    const tierBadge = e.target.closest('.division-modal-tier-badge');
                    if (tierBadge) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const division = tierBadge.dataset.division;
                        const tier = tierBadge.dataset.tier;
                        
                        // Navigate to standings page
                        window.location.href = `/${division}/${tier}`;
                        this.closeMobileModal();
                        return;
                    }
                });

                // Close modal on escape
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeMobileModal();
                    }
                });
            }

            openMobileModal() {
                const modal = document.querySelector('.division-modal');
                if (modal) {
                    modal.classList.add('show');
                    document.body.style.overflow = 'hidden';
                }
            }

            closeMobileModal() {
                const modal = document.querySelector('.division-modal');
                if (modal) {
                    modal.classList.remove('show');
                    document.body.style.overflow = '';
                }
            }
            
            openMegaMenu() {
                const megaMenu = document.querySelector('.mega-menu');
                const dropdownBtn = document.querySelector('.brand-subtitle-btn');
                
                if (megaMenu && dropdownBtn) {
                    megaMenu.classList.add('show');
                    dropdownBtn.setAttribute('aria-expanded', 'true');
                }
            }
            
            closeMegaMenu() {
                const megaMenu = document.querySelector('.mega-menu');
                const dropdownBtn = document.querySelector('.brand-subtitle-btn');
                
                if (megaMenu && dropdownBtn) {
                    megaMenu.classList.remove('show');
                    dropdownBtn.setAttribute('aria-expanded', 'false');
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new DivisionSelector();
            new MagazineSection();
            new NavigationHandler();
        });
    </script>
</body>
</html> 